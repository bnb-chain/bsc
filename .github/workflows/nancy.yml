name: Go Nancy

on:
  pull_request_target:
    branches: ["master", "develop"]
    types: [opened, synchronize, reopened]

jobs:
  build:
    strategy:
      matrix:
        go-version: [1.24.x]
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout base repo safely
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}


      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Install Nancy
        run: |
          curl -sSL -o nancy https://github.com/sonatype-nexus-community/nancy/releases/download/v1.0.52/nancy-v1.0.52-linux-amd64
          chmod +x nancy
          sudo mv nancy /usr/local/bin/
          file /usr/local/bin/nancy

      - name: Configure OSS Index
        run: |
          mkdir -p $HOME/.ossindex
          cat > $HOME/.ossindex/config.json <<EOF
          {
            "username": "${{ secrets.OSSINDEX_USERNAME }}",
            "token": "${{ secrets.OSSINDEX_TOKEN }}"
          }
          EOF

      - name: Nancy Scan
        run: |
          go list -json -deps ./... | nancy sleuth --loud