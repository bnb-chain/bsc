const DEFAULT_FOOTER_MENUS = [
  {
    "id": 1,
    "items": [
      {
        "data_analytics_id": "click_footer_chains_bsc",
        "href": "https://www.bnbchain.org/en/bnb-smart-chain",
        "id": 34,
        "menu": 1,
        "sort": 4,
        "target": "_self",
        "title": "BNB Smart Chain",
        "data-analytics-id": "click_footer_chains_bsc"
      },
      {
        "data_analytics_id": "click_footer_chains_gf",
        "href": "https://greenfield.bnbchain.org/en",
        "id": 35,
        "menu": 1,
        "sort": 5,
        "target": "_self",
        "title": "BNB Greenfield",
        "data-analytics-id": "click_footer_chains_gf"
      },
      {
        "data_analytics_id": "click_footer_chains_opBNB",
        "href": "https://opbnb.bnbchain.org/en",
        "id": 36,
        "menu": 1,
        "sort": 6,
        "target": "_self",
        "title": "opBNB",
        "data-analytics-id": "click_footer_chains_opBNB"
      }
    ],
    "menu": "Chains"
  },
  {
    "id": 2,
    "items": [
      {
        "data_analytics_id": "click_footer_use_wallets",
        "href": "https://www.bnbchain.org/en/wallets",
        "id": 38,
        "menu": 2,
        "sort": 3,
        "target": "_self",
        "title": "Download Wallet",
        "data-analytics-id": "click_footer_use_wallets"
      },
      {
        "data_analytics_id": "click_footer_use_getBNB",
        "href": "https://www.bnbchain.org/en/what-is-bnb",
        "id": 39,
        "menu": 2,
        "sort": 4,
        "target": "_self",
        "title": "Get BNB",
        "data-analytics-id": "click_footer_use_getBNB"
      },
      {
        "data_analytics_id": "click_footer_use_staking",
        "href": "https://www.bnbchain.org/en/bnb-staking",
        "id": 40,
        "menu": 2,
        "sort": 5,
        "target": "_self",
        "title": "Stake BNB",
        "data-analytics-id": "click_footer_use_staking"
      },
      {
        "data_analytics_id": "click_footer_use_bnb-chain-bridge",
        "href": "https://www.bnbchain.org/en/bnb-chain-bridge",
        "id": 21,
        "menu": 2,
        "sort": 6,
        "target": "_self",
        "title": "Bridge Assets",
        "data-analytics-id": "click_footer_use_bnb-chain-bridge"
      },
      {
        "data_analytics_id": "click_footer_use_DappBay",
        "href": "https://dappbay.bnbchain.org?utm_source=Org&utm_medium=Channel&utm_campaign=homepage_240124&utm_content=homepage",
        "id": 17,
        "menu": 2,
        "sort": 7,
        "target": "_blank",
        "title": "Explore dApps",
        "data-analytics-id": "click_footer_use_DappBay"
      },
      {
        "data_analytics_id": "click_footer_use_BTCFi",
        "href": "https://btcfi.bnbchain.org/",
        "id": 41,
        "menu": 2,
        "sort": 8,
        "target": "_self",
        "title": "Earn by BTC",
        "data-analytics-id": "click_footer_use_BTCFi"
      },
      {
        "data_analytics_id": "click_footer_use_payment",
        "href": "https://www.bnbchain.org/en/payment",
        "id": 42,
        "menu": 2,
        "sort": 9,
        "target": "_self",
        "title": "Pay by Crypto",
        "data-analytics-id": "click_footer_use_payment"
      },
      {
        "data_analytics_id": "click_footer_use_liquidStaking",
        "href": "https://www.bnbchain.org/en/liquid-staking",
        "id": 43,
        "menu": 2,
        "sort": 10,
        "target": "_self",
        "title": "Earn by Liquid Staking",
        "data-analytics-id": "click_footer_use_liquidStaking"
      }
    ],
    "menu": "Use BNB Chain"
  },
  {
    "id": 5,
    "items": [
      {
        "data_analytics_id": "click_footer_example-hub",
        "href": "https://www.bnbchain.org/en/example-hub",
        "id": 56,
        "menu": 5,
        "sort": 2,
        "target": "_self",
        "title": "Demos & Tutorials",
        "data-analytics-id": "click_footer_example-hub"
      },
      {
        "data_analytics_id": "click_footer_build_docs",
        "href": "https://docs.bnbchain.org",
        "id": 50,
        "menu": 5,
        "sort": 3,
        "target": "_blank",
        "title": "Documentations",
        "data-analytics-id": "click_footer_build_docs"
      },
      {
        "data_analytics_id": "click_footer_build_faucet",
        "href": "https://www.bnbchain.org/en/testnet-faucet",
        "id": 51,
        "menu": 5,
        "sort": 4,
        "target": "_self",
        "title": "Faucet",
        "data-analytics-id": "click_footer_build_faucet"
      },
      {
        "data_analytics_id": "click_footer_build_devTools",
        "href": "https://www.bnbchain.org/en/dev-tools",
        "id": 52,
        "menu": 5,
        "sort": 5,
        "target": "_self",
        "title": "Dev Tools",
        "data-analytics-id": "click_footer_build_devTools"
      },
      {
        "data_analytics_id": "click_footer_build_submit-dApp",
        "href": "https://dappbay.bnbchain.org/submit-dapp",
        "id": 53,
        "menu": 5,
        "sort": 6,
        "target": "_blank",
        "title": "Submit dApp",
        "data-analytics-id": "click_footer_build_submit-dApp"
      },
      {
        "data_analytics_id": "click_footer_build_DCellar",
        "href": "https://dcellar.io/",
        "id": 54,
        "menu": 5,
        "sort": 7,
        "target": "_blank",
        "title": "Greenfield Console",
        "data-analytics-id": "click_footer_build_DCellar"
      },
      {
        "data_analytics_id": "click_footer_build_BNBChainList",
        "href": "https://www.bnbchainlist.org",
        "id": 55,
        "menu": 5,
        "sort": 8,
        "target": "_blank",
        "title": "BNBChain List",
        "data-analytics-id": "click_footer_build_BNBChainList"
      },
      {
        "data_analytics_id": "click_footer_build_whitepaper",
        "href": "https://github.com/bnb-chain/whitepaper",
        "id": 19,
        "menu": 5,
        "sort": 9,
        "target": "_blank",
        "title": "Whitepaper",
        "data-analytics-id": "click_footer_build_whitepaper"
      }
    ],
    "menu": "Build"
  },
  {
    "id": 3,
    "items": [
      {
        "data_analytics_id": "click_footer_participate_events",
        "href": "https://www.bnbchain.org/en/events",
        "id": 22,
        "menu": 3,
        "sort": 1,
        "target": "_self",
        "title": "Events",
        "data-analytics-id": "click_footer_participate_events"
      },
      {
        "data_analytics_id": "click_footer_participate_hackcathon",
        "href": "https://www.bnbchain.org/en/hackathons",
        "id": 24,
        "menu": 3,
        "sort": 2,
        "target": "_self",
        "title": "Hackathon",
        "data-analytics-id": "click_footer_participate_hackcathon"
      },
      {
        "data_analytics_id": "click_footer_participate_MVB",
        "href": "https://www.bnbchain.org/en/programs/mvb",
        "id": 23,
        "menu": 3,
        "sort": 3,
        "target": "_self",
        "title": "MVB Program",
        "data-analytics-id": "click_footer_participate_MVB"
      },
      {
        "data_analytics_id": "click_footer_participate_devProgs",
        "href": "https://www.bnbchain.org/en/programs",
        "id": 25,
        "menu": 3,
        "sort": 4,
        "target": "_self",
        "title": "Builder Support Programs",
        "data-analytics-id": "click_footer_participate_devProgs"
      },
      {
        "data_analytics_id": "click_footer_participate_martiansProgram",
        "href": "https://www.bnbchain.org/en/martians-program",
        "id": 26,
        "menu": 3,
        "sort": 5,
        "target": "_self",
        "title": "Martians Program",
        "data-analytics-id": "click_footer_participate_martiansProgram"
      },
      {
        "data_analytics_id": "click_footer_participate_governance",
        "href": "https://www.bnbchain.org/en/bnb-chain-governance",
        "id": 44,
        "menu": 3,
        "sort": 6,
        "target": "_self",
        "title": "Governance",
        "data-analytics-id": "click_footer_participate_governance"
      },
      {
        "data_analytics_id": "click_footer_participate_bugBounty",
        "href": "https://bugbounty.bnbchain.org",
        "id": 27,
        "menu": 3,
        "sort": 7,
        "target": "_blank",
        "title": "Bug Bounty",
        "data-analytics-id": "click_footer_participate_bugBounty"
      },
      {
        "data_analytics_id": "click_footer_participate_space-b",
        "href": "https://www.bnbchain.org/en/space-b",
        "id": 46,
        "menu": 3,
        "sort": 9,
        "target": "_self",
        "title": "Get Workspace",
        "data-analytics-id": "click_footer_participate_space-b"
      },
      {
        "data_analytics_id": "click_footer_participate_EcosystemJobs",
        "href": "https://jobs.bnbchain.org/jobs",
        "id": 47,
        "menu": 3,
        "sort": 10,
        "target": "_blank",
        "title": "Ecosystem Jobs",
        "data-analytics-id": "click_footer_participate_EcosystemJobs"
      }
    ],
    "menu": "Participate"
  },
  {
    "id": 4,
    "items": [
      {
        "data_analytics_id": "click_footer_about_blog",
        "href": "https://www.bnbchain.org/en/blog",
        "id": 48,
        "menu": 4,
        "sort": 1,
        "target": "_blank",
        "title": "Blog",
        "data-analytics-id": "click_footer_about_blog"
      },
      {
        "data_analytics_id": "click_footer_about_careers",
        "href": "https://jobs.bnbchain.org/companies/bnb-chain#content",
        "id": 30,
        "menu": 4,
        "sort": 2,
        "target": "_blank",
        "title": "Careers",
        "data-analytics-id": "click_footer_about_careers"
      },
      {
        "data_analytics_id": "click_footer_about_verirfication",
        "href": "https://www.bnbchain.org/en/official-verification",
        "id": 31,
        "menu": 4,
        "sort": 3,
        "target": "_self",
        "title": "BNB Chain Verify",
        "data-analytics-id": "click_footer_about_verirfication"
      },
      {
        "data_analytics_id": "click_footer_about_red-alarm",
        "href": "https://dappbay.bnbchain.org/red-alarm/dapp",
        "id": 49,
        "menu": 4,
        "sort": 4,
        "target": "_blank",
        "title": "Red Alarm",
        "data-analytics-id": "click_footer_about_red-alarm"
      },
      {
        "data_analytics_id": "click_footer_about_privacy-policy",
        "href": "https://www.bnbchain.org/en/privacy-policy",
        "id": 28,
        "menu": 4,
        "sort": 5,
        "target": "_self",
        "title": "Privacy Policy",
        "data-analytics-id": "click_footer_about_privacy-policy"
      },
      {
        "data_analytics_id": "click_footer_about_tou",
        "href": "https://www.bnbchain.org/en/terms",
        "id": 29,
        "menu": 4,
        "sort": 6,
        "target": "_self",
        "title": "Terms of Use",
        "data-analytics-id": "click_footer_about_tou"
      },
      {
        "data_analytics_id": "click_footer_about_contactUs",
        "href": "https://www.bnbchain.org/en/contact",
        "id": 32,
        "menu": 4,
        "sort": 7,
        "target": "_self",
        "title": "Contact Us",
        "data-analytics-id": "click_footer_about_contactUs"
      },
      {
        "data_analytics_id": "click_footer_about_brandGuidelines",
        "href": "https://www.bnbchain.org/en/brand-guidelines",
        "id": 33,
        "menu": 4,
        "sort": 8,
        "target": "_self",
        "title": "Brand Guidelines",
        "data-analytics-id": "click_footer_about_brandGuidelines"
      }
    ],
    "menu": "About"
  }
]

let cachedFooterMenus = null;

async function fetchFooterMenus() {
  // If we already have cached data, return it
  if (cachedFooterMenus) {
    return cachedFooterMenus;
  }

  try {
    const response = await fetch('https://www.bnbchain.org/api/v1/landing-menus');
    const data = await response.json();
    // Cache the response
    cachedFooterMenus = data.footerMenus ?? DEFAULT_FOOTER_MENUS;
    return cachedFooterMenus;
  } catch (error) {
    console.error('Error fetching footer menus:', error);
    // Cache the default menus in case of error
    cachedFooterMenus = DEFAULT_FOOTER_MENUS;
    return cachedFooterMenus;
  }
}

function createMenuHTML(menu) {
  const title = menu.menu;
  return `
    <div>
      <div>${title}</div>
      <ul>
        ${menu.items.map(item => `
          <li>
            <a
              href="${item.href}"
              target="${item.target}"
              ${item.data_analytics_id ? `data-analytics-id="${item.data_analytics_id}"` : ''}
            >
              ${item.title}
            </a>
          </li>
        `).join('')}
      </ul>
    </div>
  `;
}

let observer = null;
let isUpdating = false;

function setupObserver() {
  if (observer) {
    observer.disconnect();
  }

  const targetNode = document.body;
  const config = { childList: true, subtree: true };

  const callback = (mutationsList, observer) => {
    // Prevent recursive calls
    if (isUpdating) {
      return;
    }

    for (const mutation of mutationsList) {
      if (mutation.type === 'childList') {
        const footerInner = document.querySelector('.doc-footer__inner');
        const copyrightInner = document.querySelector('.doc-copyright__inner');

        // Only update if footer elements are missing or empty
        if ((!footerInner || !footerInner.children.length) ||
            (!copyrightInner || !copyrightInner.children.length)) {

          // Set flag before updating
          isUpdating = true;

          // Use setTimeout to break the synchronous execution chain
          setTimeout(() => {
            initializeFooterMenus();
            isUpdating = false;
          }, 0);

          break;
        }
      }
    }
  };

  observer = new MutationObserver(callback);
  observer.observe(targetNode, config);
}

// Initialize footer content
function initializeFooterMenus() {
  // Skip if already has content
  const footerInner = document.querySelector('.doc-footer__inner');
  const copyrightElement = document.querySelector('.doc-copyright__inner');

  if (footerInner?.children.length && copyrightElement?.children.length) {
    return;
  }

  // If we have cached data, use it immediately
  if (cachedFooterMenus) {
    updateFooterContent(cachedFooterMenus);
    return;
  }

  // Only fetch if we don't have cached data
  fetchFooterMenus().then(footerMenus => {
    updateFooterContent(footerMenus);
  });
}

// Update footer content without triggering observer
function updateFooterContent(footerMenus) {
  if (!footerMenus) return;

  const footerInner = document.querySelector('.doc-footer__inner');
  const copyrightElement = document.querySelector('.doc-copyright__inner');

  if (footerInner && (!footerInner.children.length)) {
    footerInner.innerHTML = footerMenus.map(menu => createMenuHTML(menu)).join('');
  }

  if (copyrightElement && (!copyrightElement.children.length)) {
    const currentYear = new Date().getFullYear();
    copyrightElement.innerHTML = `© ${currentYear} Bnbchain.org. All rights reserved.`;
  }
}

// Handle initial page load
document.addEventListener('DOMContentLoaded', () => {
  initializeFooterMenus();
  setupObserver();
});